{% extends "base.html" %}

{% block title %}Manual Attendance{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-hand-paper"></i> Manual Check-in</h1>
        <p class="lead">For students experiencing device or connectivity issues</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Quick Check-in</h5>
            </div>
            <div class="card-body">
                <form id="manualCheckinForm">
                    <div class="row">
                        <div class="col-md-8">
                            <select class="form-select" id="student_id" name="student_id" required>
                                <option value="">Select a student...</option>
                                {% for student in students %}
                                <option value="{{ student[0] }}">{{ student[1] }} ({{ student[0] }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-check"></i> Check In
                            </button>
                        </div>
                    </div>
                </form>
                
                <div id="result" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Bulk Check-in</h5>
            </div>
            <div class="card-body">
                <p>Select multiple students for group check-in:</p>
                
                <div class="row">
                    {% for student in students %}
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   value="{{ student[0] }}" id="bulk_{{ student[0] }}">
                            <label class="form-check-label" for="bulk_{{ student[0] }}">
                                {{ student[1] }} ({{ student[0] }})
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <button onclick="bulkCheckIn()" class="btn btn-warning">
                        <i class="fas fa-users"></i> Check In Selected Students
                    </button>
                    <button onclick="selectAll()" class="btn btn-outline-secondary">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button onclick="clearAll()" class="btn btn-outline-secondary">
                        <i class="fas fa-square"></i> Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Manual Check-in Info</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> When to Use:</h6>
                    <ul class="small mb-0">
                        <li>Student's phone is not working</li>
                        <li>Bluetooth/QR issues</li>
                        <li>Student forgot device</li>
                        <li>Network connectivity problems</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> Note:</h6>
                    <p class="small mb-0">
                        Manual check-ins are marked differently in the system 
                        for tracking purposes.
                    </p>
                </div>
                
                <h6>Quick Stats:</h6>
                <ul class="list-unstyled">
                    <li><strong>Total Students:</strong> {{ students|length }}</li>
                    <li><strong>Checked In Today:</strong> <span id="checkedInCount">0</span></li>
                    <li><strong>Remaining:</strong> <span id="remainingCount">{{ students|length }}</span></li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="/dashboard" class="btn btn-outline-primary w-100 mb-2">
                    <i class="fas fa-chart-bar"></i> View Dashboard
                </a>
                <a href="/qr_attendance" class="btn btn-outline-info w-100 mb-2">
                    <i class="fas fa-qrcode"></i> Create QR Session
                </a>
                <a href="/students" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-users"></i> Manage Students
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('manualCheckinForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const resultDiv = document.getElementById('result');
    
    fetch('/manual_checkin', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check"></i> ${data.message}
                </div>
            `;
            this.reset();
            updateStats();
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Error: ${error}
            </div>
        `;
    });
});

function bulkCheckIn() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    const selectedStudents = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedStudents.length === 0) {
        alert('Please select at least one student');
        return;
    }
    
    if (!confirm(`Check in ${selectedStudents.length} students?`)) {
        return;
    }
    
    let completed = 0;
    let success = 0;
    
    selectedStudents.forEach(studentId => {
        const formData = new FormData();
        formData.append('student_id', studentId);
        
        fetch('/manual_checkin', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            completed++;
            if (data.success) success++;
            
            if (completed === selectedStudents.length) {
                alert(`Bulk check-in complete: ${success}/${selectedStudents.length} successful`);
                clearAll();
                updateStats();
            }
        })
        .catch(error => {
            completed++;
            if (completed === selectedStudents.length) {
                alert(`Bulk check-in complete with some errors`);
                clearAll();
            }
        });
    });
}

function selectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function clearAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function updateStats() {
    // This would ideally fetch current attendance stats
    // For now, we'll just reload the page to update
    setTimeout(() => location.reload(), 2000);
}
</script>
{% endblock %}
